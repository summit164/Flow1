require('dotenv').config();
const TelegramBot = require('node-telegram-bot-api');
const axios = require('axios');

// –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∏ URL –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
const token = process.env.BOT_TOKEN;
const webAppUrl = process.env.WEBAPP_URL;

// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
const bot = new TelegramBot(token, { polling: true });

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ webhook –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
async function clearWebhookAndRefresh() {
  try {
    // –£–¥–∞–ª—è–µ–º webhook, –µ—Å–ª–∏ –æ–Ω –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
    await bot.setWebHook('');
    console.log('Webhook —É–¥–∞–ª–µ–Ω');
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ –∑–∞–Ω–æ–≤–æ
    await bot.setMyCommands([
      { command: 'start', description: '–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –∏ –æ—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–∞–ª–æ–≥' },
      { command: 'phone', description: '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞' },
      { command: 'myorders', description: '–ú–æ–∏ –∑–∞–∫–∞–∑—ã' },
      { command: 'clear', description: '–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à' }
    ]);
    console.log('–ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –º–µ–Ω—é, —á—Ç–æ–±—ã –æ–Ω–∞ –≤—Å–µ–≥–¥–∞ –±—ã–ª–∞ –≤–∏–¥–Ω–∞
    await bot.setChatMenuButton({
      type: 'commands'
    });
    console.log('–ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
    
    console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã. URL –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:', webAppUrl);
  } catch (error) {
    console.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error.message);
  }
}

// –§—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–∞ –≤ –∫–æ–Ω—Ü–µ —Ñ–∞–π–ª–∞ –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞
async function clearAllBotSettings() {
  try {
    console.log('üßπ –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ª–Ω—É—é –æ—á–∏—Å—Ç–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞...');
    
    // –£–¥–∞–ª—è–µ–º webhook
    await bot.setWebHook('');
    console.log('‚úÖ Webhook —É–¥–∞–ª–µ–Ω');
    
    // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã
    await bot.setMyCommands([]);
    console.log('‚úÖ –ö–æ–º–∞–Ω–¥—ã –æ—á–∏—â–µ–Ω—ã');
    
    // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã
    await bot.setMyCommands([
      { command: 'start', description: '–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –∏ –æ—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–∞–ª–æ–≥' },
      { command: 'phone', description: '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞' },
      { command: 'myorders', description: '–ú–æ–∏ –∑–∞–∫–∞–∑—ã' },
      { command: 'clear', description: '–û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à' }
    ]);
    console.log('‚úÖ –ù–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –º–µ–Ω—é, —á—Ç–æ–±—ã –æ–Ω–∞ –≤—Å–µ–≥–¥–∞ –±—ã–ª–∞ –≤–∏–¥–Ω–∞
    await bot.setChatMenuButton({
      type: 'commands'
    });
    console.log('‚úÖ –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
    
    console.log('üéâ –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
    return true;
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
    return false;
  }
}



// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
bot.onText(/\/start/, async (msg) => {
  const chatId = msg.chat.id;
  const firstName = msg.from.first_name;

  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –º–µ–Ω—é –¥–ª—è —ç—Ç–æ–≥–æ —á–∞—Ç–∞
  try {
    await bot.setChatMenuButton({
      chat_id: chatId,
      type: 'commands'
    });
    console.log('–ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è —á–∞—Ç–∞:', chatId);
  } catch (error) {
    console.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é:', error.message);
  }

  // –í—ã–≤–æ–¥–∏–º URL –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
  console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–π URL –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:', webAppUrl);
  
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º URL –≤ —á–∞—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
  bot.sendMessage(chatId, `–¢–µ–∫—É—â–∏–π URL –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ${webAppUrl}`);

  // –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º
  const keyboard = {
    reply_markup: {
      keyboard: [
        [{ text: 'üå∫ –ö–∞—Ç–∞–ª–æ–≥', web_app: { url: webAppUrl } }],
        [{ text: 'üõí –ú–æ—è –∫–æ—Ä–∑–∏–Ω–∞' }],
        [{ text: 'üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏' }]
      ],
      resize_keyboard: true,
      persistent: true
    }
  };

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
  bot.sendMessage(
    chatId,
    `–ü—Ä–∏–≤–µ—Ç, ${firstName}! üëã\n\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω —Ü–≤–µ—Ç–æ–≤! üåπ\n\n–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "üå∫ –ö–∞—Ç–∞–ª–æ–≥", —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –≤ –Ω–∞—à –∫–∞—Ç–∞–ª–æ–≥ –∏ –≤—ã–±—Ä–∞—Ç—å –±—É–∫–µ—Ç.`,
    keyboard
  );
});

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Å–≤—è–∑–∏ Telegram ID —Å –Ω–æ–º–µ—Ä–∞–º–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤
const userPhones = new Map();

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /phone
bot.onText(/\/phone/, (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  
  bot.sendMessage(
    chatId,
    'üì± –î–ª—è —Å–≤—è–∑–∏ –∑–∞–∫–∞–∑–æ–≤ —Å –≤–∞—à–∏–º –∞–∫–∫–∞—É–Ω—Ç–æ–º, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.\n\n' +
    '–§–æ—Ä–º–∞—Ç: +7 (999) 123-45-67 –∏–ª–∏ 89991234567\n\n' +
    'üí° –ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞ –≤—ã —Å–º–æ–∂–µ—Ç–µ –≤–∏–¥–µ—Ç—å –≤—Å–µ —Å–≤–æ–∏ –∑–∞–∫–∞–∑—ã –≤ –±–æ—Ç–µ.',
    {
      reply_markup: {
        force_reply: true,
        input_field_placeholder: '+7 (999) 123-45-67'
      }
    }
  );
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –æ–∂–∏–¥–∞–Ω–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
  userPhones.set(userId, { waitingForPhone: true });
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /myorders
bot.onText(/\/myorders/, async (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  
  try {
    let orders = [];
    
    // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã –ø–æ Telegram ID
    const telegramOrders = await getUserOrders(userId.toString());
    if (telegramOrders && telegramOrders.length > 0) {
      orders = telegramOrders;
    } else {
      // –ï—Å–ª–∏ –∑–∞–∫–∞–∑–æ–≤ –ø–æ Telegram ID –Ω–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
      const userPhone = userPhones.get(userId);
      
      if (userPhone && userPhone.phone) {
        // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –Ω–æ–º–µ—Ä—É (—Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º 7)
        const normalizedPhoneId = `phone_${userPhone.phone.replace(/\D/g, '')}`;
        let phoneOrders = await getUserOrders(normalizedPhoneId);
        
        // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º—É –Ω–æ–º–µ—Ä—É (—Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º 8)
        if (!phoneOrders || phoneOrders.length === 0) {
          const originalPhone = userPhone.phone.replace(/\D/g, '');
          const originalPhoneId = originalPhone.startsWith('7') ? 
            `phone_8${originalPhone.slice(1)}` : `phone_${originalPhone}`;
          phoneOrders = await getUserOrders(originalPhoneId);
        }
        
        if (phoneOrders && phoneOrders.length > 0) {
          orders = phoneOrders;
        }
      }
    }
    
    // –ï—Å–ª–∏ –∑–∞–∫–∞–∑–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
    if (orders.length === 0) {
      const userPhone = userPhones.get(userId);
      let message = 'üìã –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.\n\n';
      
      if (!userPhone || !userPhone.phone) {
        message += 'üí° –î–ª—è —Å–≤—è–∑–∏ –∑–∞–∫–∞–∑–æ–≤ —Å –±–æ—Ç–æ–º:\n';
        message += '‚Ä¢ –ü—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –Ω–∞ —Å–∞–π—Ç–µ —É–∫–∞–∂–∏—Ç–µ –≤–∞—à Telegram ID: ' + userId + '\n';
        message += '‚Ä¢ –ò–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫–æ–º–∞–Ω–¥–æ–π /phone';
      } else {
        message += 'üí° –ü—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –Ω–∞ —Å–∞–π—Ç–µ —É–∫–∞–∂–∏—Ç–µ:\n';
        message += '‚Ä¢ Telegram ID: ' + userId + '\n';
        message += '‚Ä¢ –ò–ª–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: +' + userPhone.phone;
      }
      
      bot.sendMessage(chatId, message);
      return;
    }
    
    if (orders.length === 0) {
      bot.sendMessage(
        chatId,
        'üõí –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.\n\n' +
        '–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∫–∞—Ç–∞–ª–æ–≥, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –±—É–∫–µ—Ç—ã –∏ —Ü–≤–µ—Ç—ã.\n\n' +
        'üí° –ü—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –Ω–∞ —Å–∞–π—Ç–µ —É–∫–∞–∂–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: ' + userPhone.phone
      );
      return;
    }
    
    let message = `üìã –í–∞—à–∏ –∑–∞–∫–∞–∑—ã (${orders.length}):\n\n`;
    
    orders.forEach((order, index) => {
      message += `${index + 1}. ${formatOrder(order)}\n\n`;
    });
    
    message += `üìû –î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ –∑–∞–∫–∞–∑–∞–º —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏:\n`;
    message += `üì± Telegram: @RyazanovKirill\n`;
    message += `üí¨ WhatsApp: wa.me/79999999999`;
    
    bot.sendMessage(chatId, message);
    
  } catch (error) {
    console.error('Error in myorders handler:', error);
    bot.sendMessage(
      chatId,
      '‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–∫–∞–∑–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'
    );
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /clear
bot.onText(/\/clear/i, async (msg) => {
  console.log('üìû –ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /clear');
  const chatId = msg.chat.id;
  
  await bot.sendMessage(chatId, 'üßπ –ù–∞—á–∏–Ω–∞—é –ø–æ–ª–Ω—É—é –æ—á–∏—Å—Ç–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞...');
  
  const success = await clearAllBotSettings();
  
  if (success) {
    await bot.sendMessage(chatId, '‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω—ã!\n\nüéâ –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã, –∫—ç—à –æ—á–∏—â–µ–Ω. –¢–µ–ø–µ—Ä—å –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —á–∏—Å—Ç—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏.');
  } else {
    await bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
  }
});





// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥
bot.onText(/^(clear|–æ—á–∏—Å—Ç–∏—Ç—å|–∫–ª–∏—Ä)$/i, async (msg) => {
  console.log('üìû –ü–æ–ª—É—á–µ–Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ –æ—á–∏—Å—Ç–∫–∏');
  const chatId = msg.chat.id;
  await bot.sendMessage(chatId, 'üßπ –ù–∞—á–∏–Ω–∞—é –ø–æ–ª–Ω—É—é –æ—á–∏—Å—Ç–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞...');
  const success = await clearAllBotSettings();
  
  if (success) {
    const timestamp = Date.now();
    const randomId = Math.random().toString(36).substring(7);
    const clearUrl = `${webAppUrl}?clear=true&t=${timestamp}&id=${randomId}&force=true`;
    
    await bot.sendMessage(chatId, '‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—á–∏—â–µ–Ω—ã! –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É:', {
      reply_markup: {
        inline_keyboard: [[
          { text: 'üÜï –ù–û–í–ê–Ø –°–°–´–õ–ö–ê –ù–ê –ö–ê–¢–ê–õ–û–ì', web_app: { url: clearUrl } }
        ]]
      }
    });
  } else {
    await bot.sendMessage(chatId, '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
  }
});





// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function getUserOrders(userId) {
  try {
    const response = await axios.get(`${webAppUrl}/api/orders?userId=${userId}`);
    return response.data.orders || [];
  } catch (error) {
    console.error('Error fetching user orders:', error);
    return [];
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
function formatOrder(order) {
  let message = `üì¶ –ó–∞–∫–∞–∑ #${order.orderId.slice(-6)}\n`;
  message += `üìÖ –î–∞—Ç–∞: ${new Date(order.timestamp).toLocaleString('ru-RU')}\n`;
  message += `üí∞ –°—É–º–º–∞: ${order.total} ‚ÇΩ\n`;
  message += `üìã –°—Ç–∞—Ç—É—Å: ${order.status === 'pending' ? '–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è' : order.status}\n\n`;
  
  message += `üå∏ –°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞:\n`;
  order.items.forEach((item, index) => {
    message += `${index + 1}. ${item.flower.emoji} ${item.flower.name}\n`;
    message += `   –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${item.quantity} —à—Ç.\n`;
    message += `   –¶–µ–Ω–∞: ${item.flower.price * item.quantity} ‚ÇΩ\n\n`;
  });
  
  return message;
}

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è Telegram ID
bot.onText(/\/myid/, (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  
  bot.sendMessage(
    chatId,
    `üÜî –í–∞—à Telegram ID: ${userId}\n\n` +
    `üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç ID –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –Ω–∞ —Å–∞–π—Ç–µ, ` +
    `—á—Ç–æ–±—ã –ø–æ—Ç–æ–º –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∑–∞–∫–∞–∑—ã –≤ –±–æ—Ç–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "üõí –ú–æ—è –∫–æ—Ä–∑–∏–Ω–∞".`
  );
});


// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ú–æ—è –∫–æ—Ä–∑–∏–Ω–∞"
bot.onText(/üõí –ú–æ—è –∫–æ—Ä–∑–∏–Ω–∞/, async (msg) => {
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  
  try {
    let orders = [];
    
    // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã –ø–æ Telegram ID
    const telegramOrders = await getUserOrders(userId.toString());
    if (telegramOrders && telegramOrders.length > 0) {
      orders = telegramOrders;
    } else {
      // –ï—Å–ª–∏ –∑–∞–∫–∞–∑–æ–≤ –ø–æ Telegram ID –Ω–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞
      const userPhone = userPhones.get(userId);
      
      if (userPhone && userPhone.phone) {
        // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∑–∞–∫–∞–∑—ã –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –Ω–æ–º–µ—Ä—É (—Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º 7)
        const normalizedPhoneId = `phone_${userPhone.phone.replace(/\D/g, '')}`;
        let phoneOrders = await getUserOrders(normalizedPhoneId);
        
        // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º—É –Ω–æ–º–µ—Ä—É (—Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º 8)
        if (!phoneOrders || phoneOrders.length === 0) {
          const originalPhone = userPhone.phone.replace(/\D/g, '');
          const originalPhoneId = originalPhone.startsWith('7') ? 
            `phone_8${originalPhone.slice(1)}` : `phone_${originalPhone}`;
          phoneOrders = await getUserOrders(originalPhoneId);
        }
        
        if (phoneOrders && phoneOrders.length > 0) {
          orders = phoneOrders;
        }
      }
    }
    
    // –ï—Å–ª–∏ –∑–∞–∫–∞–∑–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Telegram ID
    if (orders.length === 0) {
      const userPhone = userPhones.get(userId);
      let message = 'üõí –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.\n\n';
      
      if (!userPhone || !userPhone.phone) {
        message += 'üí° –î–ª—è —Å–≤—è–∑–∏ –∑–∞–∫–∞–∑–æ–≤ —Å –±–æ—Ç–æ–º:\n';
        message += '‚Ä¢ –ü—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –Ω–∞ —Å–∞–π—Ç–µ —É–∫–∞–∂–∏—Ç–µ –≤–∞—à Telegram ID: ' + userId + '\n';
        message += '‚Ä¢ –ò–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫–æ–º–∞–Ω–¥–æ–π /phone\n\n';
        message += '–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∫–∞—Ç–∞–ª–æ–≥, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –±—É–∫–µ—Ç—ã –∏ —Ü–≤–µ—Ç—ã.';
      } else {
        message += '–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∫–∞—Ç–∞–ª–æ–≥, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –±—É–∫–µ—Ç—ã –∏ —Ü–≤–µ—Ç—ã.\n\n';
        message += 'üí° –ü—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –Ω–∞ —Å–∞–π—Ç–µ —É–∫–∞–∂–∏—Ç–µ:\n';
        message += '‚Ä¢ Telegram ID: ' + userId + '\n';
        message += '‚Ä¢ –ò–ª–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: +' + userPhone.phone;
      }
      
      bot.sendMessage(chatId, message);
      return;
    }
    
    if (orders.length === 0) {
      bot.sendMessage(
        chatId,
        'üõí –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.\n\n' +
        '–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∫–∞—Ç–∞–ª–æ–≥, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –±—É–∫–µ—Ç—ã –∏ —Ü–≤–µ—Ç—ã.\n\n' +
        'üí° –ü—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –Ω–∞ —Å–∞–π—Ç–µ —É–∫–∞–∂–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: +' + userPhone.phone
      );
      return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑ (—Å–∞–º—ã–π –∞–∫—Ç—É–∞–ª—å–Ω—ã–π)
    const latestOrder = orders[orders.length - 1];
    let message = `üõí –í–∞—à –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑:\n\n`;
    message += formatOrder(latestOrder);
    
    if (orders.length > 1) {
      message += `\nüìä –£ –≤–∞—Å ${orders.length} –∑–∞–∫–∞–∑–æ–≤ –≤—Å–µ–≥–æ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /myorders –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö.`;
    }
    
    message += `\n\nüí¨ –î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏:\n`;
    message += `üìû –¢–µ–ª–µ—Ñ–æ–Ω: 89999999999\n`;
    message += `üì± Telegram: @RyazanovKirill\n`;
    message += `üí¨ WhatsApp: wa.me/79999999999`;
    
    bot.sendMessage(chatId, message);
    
  } catch (error) {
    console.error('Error in cart handler:', error);
    bot.sendMessage(
      chatId,
      '‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ—Ä–∑–∏–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'
    );
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "üå∫ –ö–∞—Ç–∞–ª–æ–≥"
bot.onText(/üå∫ –ö–∞—Ç–∞–ª–æ–≥/, async (msg) => {
  const chatId = msg.chat.id;
  
  // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  const timestamp = Date.now();
  const randomId = Math.random().toString(36).substring(7);
  const catalogUrl = `${webAppUrl}?catalog=true&t=${timestamp}&id=${randomId}`;
  
  console.log('–û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ç–∞–ª–æ–≥ –ø–æ URL:', catalogUrl);
  
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º inline-–∫–Ω–æ–ø–∫—É —Å –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º
  bot.sendMessage(
    chatId,
    'üå∫ –ö–∞—Ç–∞–ª–æ–≥ —Ü–≤–µ—Ç–æ–≤ –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ—Å–º–æ—Ç—Ä—É!\n\n–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–∞–ª–æ–≥:',
    {
      reply_markup: {
        inline_keyboard: [[
          { text: 'üå∏ –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–∞–ª–æ–≥ —Ü–≤–µ—Ç–æ–≤', web_app: { url: catalogUrl } }
        ]]
      }
    }
  );
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏"
bot.onText(/üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏/, (msg) => {
  const chatId = msg.chat.id;
  
  bot.sendMessage(
    chatId,
    '–í—ã –º–æ–∂–µ—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É: +7 (XXX) XXX-XX-XX\n\n–ò–ª–∏ –Ω–∞–ø–∏—Å–∞—Ç—å –Ω–∞–º –Ω–∞ email: flowers@example.com'
  );
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∞–Ω–Ω—ã—Ö, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –∏–∑ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
bot.on('web_app_data', (msg) => {
  const chatId = msg.chat.id;
  const data = msg.web_app_data.data;
  
  try {
    // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
    const parsedData = JSON.parse(data);
    
    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    // –ù–∞–ø—Ä–∏–º–µ—Ä, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω—É
    
    bot.sendMessage(
      chatId,
      `–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã: ${JSON.stringify(parsedData, null, 2)}`
    );
  } catch (error) {
    bot.sendMessage(
      chatId,
      '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.'
    );
    console.error('Error parsing web app data:', error);
  }
});

// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–≤ –∫–æ–Ω—Ü–µ, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å –¥—Ä—É–≥–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º)
bot.on('message', (msg) => {
  console.log('=== –í–•–û–î–Ø–©–ï–ï –°–û–û–ë–©–ï–ù–ò–ï ===');
  console.log('–¢–µ–∫—Å—Ç:', msg.text);
  console.log('–¢–∏–ø:', msg.chat.type);
  console.log('ID —á–∞—Ç–∞:', msg.chat.id);
  console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', msg.from.username || msg.from.first_name);
  console.log('========================');
  
  const chatId = msg.chat.id;
  const userId = msg.from.id;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–∂–∏–¥–∞–µ–º –ª–∏ –º—ã –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –æ—Ç —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const userState = userPhones.get(userId);
  if (userState && userState.waitingForPhone && msg.text && !msg.text.startsWith('/')) {
    const phoneText = msg.text.trim();
    
    // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    const phoneRegex = /^(\+7|8|7)?[\s\-\(\)]?(\d{3})[\s\-\(\)]?(\d{3})[\s\-]?(\d{2})[\s\-]?(\d{2})$/;
    
    if (phoneRegex.test(phoneText)) {
      // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
      const cleanPhone = phoneText.replace(/\D/g, '');
      const normalizedPhone = cleanPhone.startsWith('8') ? '7' + cleanPhone.slice(1) : 
                             cleanPhone.startsWith('7') ? cleanPhone : '7' + cleanPhone;
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
      userPhones.set(userId, { 
        phone: normalizedPhone,
        waitingForPhone: false,
        registeredAt: new Date().toISOString()
      });
      
      bot.sendMessage(
        chatId,
        `‚úÖ –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: +${normalizedPhone}\n\n` +
        'üéâ –¢–µ–ø–µ—Ä—å –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ —Å–∞–π—Ç–µ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ —ç—Ç–æ—Ç –Ω–æ–º–µ—Ä, ' +
        '–∏ –≤—ã —Å–º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –≤—Å–µ —Å–≤–æ–∏ –∑–∞–∫–∞–∑—ã –∫–æ–º–∞–Ω–¥–æ–π /myorders\n\n' +
        'üí° –¢–∞–∫–∂–µ –∑–∞–∫–∞–∑—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –∫–Ω–æ–ø–∫–µ "üõí –ú–æ—è –∫–æ—Ä–∑–∏–Ω–∞"',
        {
          reply_markup: {
            keyboard: [
              [{ text: 'üå∫ –ö–∞—Ç–∞–ª–æ–≥', web_app: { url: webAppUrl } }],
              [{ text: 'üõí –ú–æ—è –∫–æ—Ä–∑–∏–Ω–∞' }, { text: 'üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏' }]
            ],
            resize_keyboard: true,
            persistent: true
          }
        }
      );
      return;
    } else {
      bot.sendMessage(
        chatId,
        '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞.\n\n' +
        '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n' +
        '+7 (999) 123-45-67\n' +
        '89991234567\n' +
        '79991234567\n\n' +
        '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:'
      );
      return;
    }
  }
  
  // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –¥—Ä—É–≥–∏–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏
  if (
    msg.text && (
      msg.text.startsWith('/') ||
      msg.text === 'üõí –ú–æ—è –∫–æ—Ä–∑–∏–Ω–∞' ||
      msg.text === 'üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏' ||
      msg.text === 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å' ||
      msg.text.includes('–ö–∞—Ç–∞–ª–æ–≥ —Ü–≤–µ—Ç–æ–≤') ||
      /^(refresh|—Ä–µ—Ñ—Ä–µ—à|–æ–±–Ω–æ–≤–∏—Ç—å|clear|–æ—á–∏—Å—Ç–∏—Ç—å|–∫–ª–∏—Ä|newurl|–Ω–æ–≤–∞—è —Å—Å—ã–ª–∫–∞|–Ω–æ–≤—ã–π —É—Ä–ª)$/i.test(msg.text)
    ) ||
    msg.web_app_data
  ) {
    return;
  }

  // –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  bot.sendMessage(
    chatId,
    '–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –ø–æ–Ω–∏–º–∞—é —ç—Ç—É –∫–æ–º–∞–Ω–¥—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –∏–ª–∏ –∫–æ–º–∞–Ω–¥—ã:\n\n/start - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n/clear - –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à\n/newurl - –ù–æ–≤–∞—è —Å—Å—ã–ª–∫–∞'
  );
});

// –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
console.log('–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –æ–∂–∏–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π...');

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞ –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
setTimeout(async () => {
  await clearWebhookAndRefresh();
}, 1000);